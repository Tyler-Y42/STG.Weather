<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>St. George Weather</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            padding: 12px;
        }
        .container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: 1.1fr 1.1fr 2.48fr 0.54fr 0.36fr auto;
            gap: 10px;
        }
        
        /* Rows 1 & 2: Cards remain 3-column layout */
        .temp-main { grid-column: 1 / 3; }
        .forecast-card { grid-column: 3 / 5; }
        .wind-card { grid-column: 5 / 7; }
        .sunset-card { grid-column: 1 / 3; }
        .precip-card { grid-column: 3 / 5; }
        .pressure-card { grid-column: 5 / 7; }
        
        /* Row 3: BOTH forecast charts side by side, EXACTLY 50/50 */
        .forecast-graph-card { 
            grid-column: 1 / 4; 
            grid-row: 3; 
        }
        .week-forecast-card { 
            grid-column: 4 / 7; 
            grid-row: 3; 
        }
        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        /* Current Temp Card */
        .temp-main { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 5px; padding-bottom: 5px; }
        .temp-current { font-size: clamp(2rem, 3.2vw, 3.825rem); font-weight: 200; color: #fff; line-height: 1; }
        .temp-current a { color: #fff; text-decoration: none; }
        .temp-current a:hover { color: #74ebd5; }
        .temp-current .unit { font-size: clamp(0.8rem, 1.15vw, 1.36rem); vertical-align: super; color: #74ebd5; }
        .temp-label { font-size: clamp(0.6rem, 0.75vw, 0.8925rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 2px; margin-top: 4px; }
        
        /* Today's Forecast Card */
        .forecast-card { display: flex; flex-direction: column; justify-content: center; gap: 5.1px; padding: 10.2px 10.2px 10.2px 10.2px; padding-top: 15.2px; padding-bottom: 15.2px; }
        .forecast-card .card-title { font-size: clamp(0.55rem, 0.7vw, 0.85rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; text-align: center; margin-bottom: 2px; }
        .forecast-item { display: flex; align-items: center; justify-content: space-between; }
        .forecast-item .label { font-size: clamp(0.7rem, 0.93vw, 1.105rem); color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px; }
        .forecast-item .value { font-size: clamp(1.3rem, 1.7vw, 2.04rem); font-weight: 300; }
        .forecast-item.high .value { color: #ff6b6b; }
        .forecast-item.low .value { color: #4ecdc4; }
        
        /* 7-Day Forecast Card */
        .week-forecast-card { display: flex; flex-direction: column; padding: 14px; }
        .week-forecast-card .card-title { font-size: 1.6rem; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .week-chart-container { flex: 1; position: relative; min-height: 0; }
        
        /* Wind Card */
        .wind-card { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2.55px; padding-top: 5px; padding-bottom: 5px; }
        .wind-speed { font-size: clamp(1.8rem, 2.3vw, 2.72rem); font-weight: 200; color: #fff; }
        .wind-speed .unit { font-size: clamp(0.7rem, 0.93vw, 1.105rem); color: #74ebd5; }
        .wind-direction { display: flex; align-items: center; gap: 5.1px; }
        .wind-arrow { width: clamp(20px, 2.5vw, 30.6px); height: clamp(20px, 2.5vw, 30.6px); border: 2px solid #74ebd5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: clamp(0.7rem, 0.93vw, 1.105rem); transition: transform 0.5s ease; }
        .wind-dir-text { font-size: clamp(0.7rem, 0.93vw, 1.105rem); color: #74ebd5; font-weight: 500; }
        .wind-gust { font-size: clamp(0.6rem, 0.79vw, 0.935rem); color: rgba(255, 255, 255, 0.5); }
        .wind-gust span { color: #ff9f43; }
        
        /* Sunset Card */
        .sunset-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5.1px; padding-top: 5px; padding-bottom: 5px; }
        .sunset-value { font-size: clamp(2.3rem, 3vw, 3.57rem); font-weight: 200; color: #ff9f43; }
        .sunset-label { font-size: clamp(0.7rem, 0.93vw, 1.105rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 2px; }
        
        /* Precip Card */
        .precip-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5.1px; padding-top: 5px; padding-bottom: 5px; }
        .precip-value { font-size: clamp(2.3rem, 3vw, 3.57rem); font-weight: 200; color: #74b9ff; }
        .precip-label { font-size: clamp(0.7rem, 0.93vw, 1.105rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 2px; }
        
        /* Pressure Card */
        .pressure-card { display: flex; flex-direction: column; padding-top: 5px; padding-bottom: 5px; }
        .pressure-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.55px; }
        .pressure-value { font-size: clamp(0.8rem, 1.07vw, 1.275rem); font-weight: 200; color: #74ebd5; }
        .pressure-value .unit { font-size: clamp(0.5rem, 0.61vw, 0.7225rem); color: rgba(255, 255, 255, 0.5); }
        .pressure-label { font-size: clamp(0.5rem, 0.61vw, 0.7225rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; }
        .pressure-trend { font-size: clamp(0.55rem, 0.71vw, 0.85rem); }
        .trend-up { color: #27ae60; }
        .trend-down { color: #e74c3c; }
        .trend-stable { color: rgba(255, 255, 255, 0.5); }
        .pressure-chart-container { flex: 1; position: relative; min-height: 0; }
        
        /* Forecast Graph */
        .forecast-graph-card { display: flex; flex-direction: column; }
        .forecast-graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .forecast-graph-title { font-size: 1.6rem; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; }
        .chart-container { flex: 1; position: relative; min-height: 0; }
        canvas { width: 100% !important; height: 100% !important; }
        
        /* Extra Data Row */
        .extra-data { grid-column: 1 / -1; display: flex; justify-content: space-around; align-items: center; padding: 4px; }
        .extra-item { text-align: center; }
        .extra-item .value { font-size: clamp(0.84rem, 1.12vw, 1.344rem); color: #fff; }
        .extra-item .label { font-size: clamp(0.525rem, 0.70vw, 0.84rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        
        /* Footer */
        .short-forecast { grid-column: 1 / -1; text-align: center; padding: 8px; font-size: clamp(0.7875rem, 1.05vw, 1.26rem); color: rgba(255, 255, 255, 0.7); font-style: italic; }
        .update-footer { grid-column: 1 / -1; text-align: center; font-size: clamp(0.7875rem, 1.05vw, 1.26rem); color: rgba(255, 255, 255, 0.3); padding: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Row 1 -->
        <div class="card temp-main">
            <div class="temp-current"><a id="temp-link" href="#" target="_blank"><span id="temp-now">--</span><span class="unit">°F</span></a></div>
            <div class="temp-label">Current</div>
        </div>
        <div class="card forecast-card">
            <div class="card-title">Today's Forecast</div>
            <div class="forecast-item high"><span class="label">High</span><span class="value"><span id="forecast-high">--</span>°</span></div>
            <div class="forecast-item low"><span class="label">Low</span><span class="value"><span id="forecast-low">--</span>°</span></div>
        </div>
        <div class="card wind-card">
            <div class="wind-speed"><span id="wind-speed">--</span> <span class="unit">mph</span></div>
            <div class="wind-direction">
                <div class="wind-arrow" id="wind-arrow">↑</div>
                <span class="wind-dir-text" id="wind-dir">--</span>
            </div>
            <div class="wind-gust">Gusts: <span id="wind-gust">--</span> mph</div>
        </div>
        
        <!-- Row 2 -->
        <div class="card sunset-card">
            <div class="sunset-value" id="sunset-time">--:--</div>
            <div class="sunset-label" id="sunset-label">Sunset</div>
        </div>
        <div class="card precip-card">
            <div class="precip-value"><span id="precip-chance">--</span>%</div>
            <div class="precip-label">Chance of Precip</div>
        </div>
        <div class="card pressure-card">
            <div class="pressure-header">
                <div>
                    <div class="pressure-value"><span id="pressure-now">--</span> <span class="unit">inHg</span> <span class="pressure-trend" id="pressure-trend">--</span></div>
                    <div class="pressure-label">Pressure (24hr)</div>
                </div>
            </div>
            <div class="pressure-chart-container"><canvas id="pressure-chart"></canvas></div>
        </div>
        
        <!-- Row 3: 12hr Forecast Graph -->
        <div class="card forecast-graph-card">
            <div class="forecast-graph-header">
                <span class="forecast-graph-title">12-Hour Forecast</span>
            </div>
            <div class="chart-container"><canvas id="forecast-chart"></canvas></div>
        </div>
        
        <!-- Row 4: 7-Day Forecast -->
        <div class="card week-forecast-card">
            <div class="forecast-graph-header">
                <span class="forecast-graph-title">7-Day Forecast</span>
            </div>
            <div class="week-chart-container"><canvas id="week-chart"></canvas></div>
        </div>
        
        <!-- Row 4: Extra data -->
        <div class="card extra-data">
            <div class="extra-item"><div class="value"><span id="humidity">--</span>%</div><div class="label">Humidity</div></div>
            <div class="extra-item"><div class="value"><span id="observed-high">--</span>°</div><div class="label">24hr High</div></div>
            <div class="extra-item"><div class="value"><span id="observed-low">--</span>°</div><div class="label">24hr Low</div></div>
        </div>
        
        <div class="card short-forecast" id="short-forecast">Loading forecast...</div>
        <div class="update-footer" id="update-time">--</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        Chart.register(ChartDataLabels);
        
        const CONFIG = {
            MESOWEST_STATION: 'UCC55',
            MESOWEST_TOKEN: 'c651d1e209fa4443a42eeef956180701',
            STATION_LAT: 37.1039,
            STATION_LON: -113.6328,
            UPDATE_INTERVAL_WEATHER: 1 * 60 * 1000,
            UPDATE_INTERVAL_FORECAST: 1 * 60 * 1000,
        };

        let nwsGridInfo = null;
        let forecastChart;
        let pressureChart;
        let weekChart;
        let pressureHistory = { times: [], values: [] };

        function initForecastChart() {
            const ctx = document.getElementById('forecast-chart').getContext('2d');
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (°F)',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 1.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Precip %',
                            data: [],
                            borderColor: '#74b9ff',
                            backgroundColor: 'rgba(116, 185, 255, 0.3)',
                            borderWidth: 1.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 7,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 35,
                            right: 0
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            titleFont: { size: 20 },
                            bodyColor: '#fff',
                            bodyFont: { size: 18 },
                            displayColors: true,
                            callbacks: {
                                label: function(ctx) {
                                    if (ctx.datasetIndex === 0) return `Temp: ${ctx.parsed.y}°F`;
                                    return `Precip: ${ctx.parsed.y}%`;
                                }
                            }
                        },
                        datalabels: {
                            display: function(ctx) {
                                return ctx.datasetIndex === 0;
                            },
                            color: '#fff',
                            font: function(ctx) {
                                const width = ctx.chart.width;
                                return { size: Math.max(12, Math.min(26, width / 25)), weight: 700 };
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            formatter: function(value) {
                                return value + '°';
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: 'rgba(255,255,255,0.6)', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(12, Math.min(24, width / 27)), weight: 500 };
                                },
                                maxRotation: 0 
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { 
                                display: true, 
                                text: 'Temperature °F', 
                                color: '#ff6b6b', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(12, Math.min(22, width / 30)), weight: 600 };
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: { 
                                display: true, 
                                text: 'Precipitation %', 
                                color: '#74b9ff', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(12, Math.min(22, width / 30)), weight: 600 };
                                },
                                padding: 0 
                            },
                            grid: { drawOnChartArea: false },
                            ticks: { 
                                color: '#74b9ff', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(10, Math.min(20, width / 33)), weight: 500 };
                                },
                                stepSize: 25, 
                                padding: 20 
                            }
                        }
                    }
                }
            });
        }

        function initPressureChart() {
            const ctx = document.getElementById('pressure-chart').getContext('2d');
            pressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#74ebd5',
                        backgroundColor: 'rgba(116, 235, 213, 0.15)',
                        borderWidth: 1.5,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            titleFont: { size: 14 },
                            bodyColor: '#74ebd5',
                            bodyFont: { size: 14 },
                            displayColors: false,
                            callbacks: {
                                label: function(ctx) {
                                    return `${ctx.parsed.y.toFixed(2)} inHg`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 12 }, maxTicksLimit: 6, maxRotation: 0 }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: 'rgba(255,255,255,0.4)', 
                                font: { size: 12 }, 
                                callback: v => v.toFixed(2),
                                count: 5
                            },
                            grace: '5%'
                        }
                    }
                }
            });
        }

        function initWeekChart() {
            const ctx = document.getElementById('week-chart').getContext('2d');
            weekChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'High',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 6,
                            pointHoverRadius: 9
                        },
                        {
                            label: 'Low',
                            data: [],
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 6,
                            pointHoverRadius: 9
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 35,
                            right: 10,
                            left: 10,
                            bottom: -5
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            titleFont: { size: 20 },
                            bodyColor: '#fff',
                            bodyFont: { size: 18 },
                            displayColors: true,
                            callbacks: {
                                label: function(ctx) {
                                    return `${ctx.dataset.label}: ${ctx.parsed.y}°F`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: function(ctx) {
                                return ctx.datasetIndex === 0 ? '#ff6b6b' : '#4ecdc4';
                            },
                            font: function(ctx) {
                                const width = ctx.chart.width;
                                return { size: Math.max(12, Math.min(22, width / 30)), weight: 700 };
                            },
                            anchor: function(ctx) {
                                return ctx.datasetIndex === 0 ? 'end' : 'start';
                            },
                            align: function(ctx) {
                                return ctx.datasetIndex === 0 ? 'top' : 'bottom';
                            },
                            offset: 6,
                            formatter: function(value) {
                                return value + '°';
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: 'rgba(255,255,255,0.6)', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(12, Math.min(24, width / 27)), weight: 500 };
                                },
                                maxRotation: 0, 
                                padding: 50 
                            }
                        },
                        y: {
                            display: false,
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        async function fetchMesoWestData() {
            const params = new URLSearchParams({
                stid: CONFIG.MESOWEST_STATION,
                token: CONFIG.MESOWEST_TOKEN,
                recent: 1440,
                vars: 'air_temp,wind_speed,wind_gust,wind_direction,relative_humidity,altimeter,pressure,sea_level_pressure',
                units: 'english'
            });
            try {
                const response = await fetch(`https://api.synopticdata.com/v2/stations/timeseries?${params}`);
                const data = await response.json();
                if (data.STATION && data.STATION.length > 0) {
                    updateWeatherDisplay(data.STATION[0]);
                }
            } catch (error) { console.error('MesoWest fetch error:', error); }
        }

        function updateWeatherDisplay(station) {
            const obs = station.OBSERVATIONS;

            document.getElementById('temp-link').href = `https://mesowest.utah.edu/cgi-bin/droman/meso_base_dyn.cgi?stn=${CONFIG.MESOWEST_STATION}`;
            document.getElementById('update-time').textContent = `Last updated: ${new Date().toLocaleString()}`;

            if (obs.air_temp_set_1) {
                const temps = obs.air_temp_set_1.filter(t => t !== null);
                if (temps.length) {
                    document.getElementById('temp-now').textContent = Math.round(temps[temps.length - 1]);
                    document.getElementById('observed-high').textContent = Math.round(Math.max(...temps));
                    document.getElementById('observed-low').textContent = Math.round(Math.min(...temps));
                }
            }

            if (obs.wind_speed_set_1) {
                const w = obs.wind_speed_set_1.filter(x => x !== null);
                if (w.length) document.getElementById('wind-speed').textContent = Math.round(w[w.length - 1]);
            }
            if (obs.wind_gust_set_1) {
                const g = obs.wind_gust_set_1.filter(x => x !== null);
                if (g.length) document.getElementById('wind-gust').textContent = Math.round(g[g.length - 1]);
            }
            if (obs.wind_direction_set_1) {
                const d = obs.wind_direction_set_1.filter(x => x !== null);
                if (d.length) {
                    document.getElementById('wind-arrow').style.transform = `rotate(${d[d.length-1]}deg)`;
                    document.getElementById('wind-dir').textContent = degreesToCardinal(d[d.length-1]);
                }
            }
            if (obs.relative_humidity_set_1) {
                const h = obs.relative_humidity_set_1.filter(x => x !== null);
                if (h.length) document.getElementById('humidity').textContent = Math.round(h[h.length - 1]);
            }

            // Try multiple pressure field names - UCC55 may use pressure_set_1d or similar
            const pressureField = obs.altimeter_set_1 || obs.pressure_set_1 || obs.pressure_set_1d || obs.sea_level_pressure_set_1;
            if (pressureField && obs.date_time) {
                const validIndices = pressureField.map((v, i) => v !== null ? i : -1).filter(i => i >= 0);
                let p = validIndices.map(i => pressureField[i]);
                const times = validIndices.map(i => obs.date_time[i]);
                
                // If values are > 100, they're in millibars - convert to inHg
                if (p.length && p[0] > 100) {
                    p = p.map(v => v * 0.02953);
                }
                
                if (p.length) {
                    document.getElementById('pressure-now').textContent = p[p.length - 1].toFixed(2);
                    
                    if (p.length > 12) {
                        const diff = p[p.length - 1] - p[p.length - 13];
                        const el = document.getElementById('pressure-trend');
                        el.textContent = diff > 0.02 ? '↑' : diff < -0.02 ? '↓' : '→';
                        el.className = 'pressure-trend ' + (diff > 0.02 ? 'trend-up' : diff < -0.02 ? 'trend-down' : 'trend-stable');
                    }
                    
                    const step = Math.max(1, Math.floor(p.length / 12));
                    const chartTimes = [];
                    const chartValues = [];
                    for (let i = 0; i < p.length; i += step) {
                        chartTimes.push(new Date(times[i]).toLocaleTimeString([], { hour: 'numeric' }));
                        chartValues.push(p[i]);
                    }
                    if (chartTimes[chartTimes.length - 1] !== new Date(times[times.length - 1]).toLocaleTimeString([], { hour: 'numeric' })) {
                        chartTimes.push(new Date(times[times.length - 1]).toLocaleTimeString([], { hour: 'numeric' }));
                        chartValues.push(p[p.length - 1]);
                    }
                    
                    if (pressureChart) {
                        pressureChart.data.labels = chartTimes;
                        pressureChart.data.datasets[0].data = chartValues;
                        pressureChart.update('none');
                    }
                }
            }
        }

        function degreesToCardinal(deg) {
            const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
            return dirs[Math.round(deg / 22.5) % 16];
        }

        async function fetchNWSForecast() {
            if (!nwsGridInfo) {
                try {
                    const r = await fetch(`https://api.weather.gov/points/${CONFIG.STATION_LAT},${CONFIG.STATION_LON}`, { headers: { 'User-Agent': 'WeatherStation/1.0' } });
                    const d = await r.json();
                    nwsGridInfo = {
                        forecastUrl: d.properties.forecast,
                        forecastHourlyUrl: d.properties.forecastHourly
                    };
                } catch (e) { console.error('NWS grid error:', e); return; }
            }

            try {
                const r = await fetch(nwsGridInfo.forecastUrl, { headers: { 'User-Agent': 'WeatherStation/1.0' } });
                const d = await r.json();
                if (d.properties?.periods) updateForecastDisplay(d.properties.periods);
            } catch (e) { console.error('NWS forecast error:', e); }

            try {
                const r = await fetch(nwsGridInfo.forecastHourlyUrl, { headers: { 'User-Agent': 'WeatherStation/1.0' } });
                const d = await r.json();
                if (d.properties?.periods) updateForecastChart(d.properties.periods);
            } catch (e) { console.error('NWS hourly forecast error:', e); }
        }

        function updateForecastDisplay(periods) {
            let high = null, low = null, precip = 0, forecast = '';
            for (const p of periods) {
                if (p.isDaytime && high === null) {
                    high = p.temperature;
                    forecast = p.shortForecast;
                    if (p.probabilityOfPrecipitation?.value) precip = Math.max(precip, p.probabilityOfPrecipitation.value);
                }
                if (!p.isDaytime && low === null) {
                    low = p.temperature;
                    if (p.probabilityOfPrecipitation?.value) precip = Math.max(precip, p.probabilityOfPrecipitation.value);
                }
                if (high !== null && low !== null) break;
            }
            if (high !== null) document.getElementById('forecast-high').textContent = high;
            if (low !== null) document.getElementById('forecast-low').textContent = low;
            document.getElementById('precip-chance').textContent = precip;
            document.getElementById('short-forecast').textContent = forecast || 'Forecast unavailable';
            
            // Update 7-day forecast chart
            const dailyData = [];
            for (let i = 0; i < periods.length && dailyData.length < 7; i += 2) {
                const day = periods[i];
                const night = periods[i + 1];
                if (day && night) {
                    const date = new Date(day.startTime);
                    const dayName = date.toLocaleDateString([], { weekday: 'short' });
                    dailyData.push({
                        name: dayName,
                        high: day.isDaytime ? day.temperature : night.temperature,
                        low: night.isDaytime ? day.temperature : night.temperature
                    });
                }
            }
            
            if (dailyData.length > 0 && weekChart) {
                weekChart.data.labels = dailyData.map(d => d.name);
                weekChart.data.datasets[0].data = dailyData.map(d => d.high);
                weekChart.data.datasets[1].data = dailyData.map(d => d.low);
                weekChart.update('none');
            }
        }

        function updateForecastChart(periods) {
            const next12 = periods.slice(0, 12);
            
            const labels = next12.map(p => {
                const time = new Date(p.startTime);
                return time.toLocaleTimeString([], { hour: 'numeric' });
            });
            
            const temps = next12.map(p => p.temperature);
            const precips = next12.map(p => p.probabilityOfPrecipitation?.value || 0);

            if (forecastChart) {
                forecastChart.data.labels = labels;
                forecastChart.data.datasets[0].data = temps;
                forecastChart.data.datasets[1].data = precips;
                forecastChart.update('none');
            }
        }

        async function fetchSunsetTime() {
            try {
                const r = await fetch(`https://api.sunrise-sunset.org/json?lat=${CONFIG.STATION_LAT}&lng=${CONFIG.STATION_LON}&formatted=0`);
                const d = await r.json();
                if (d.status === 'OK') {
                    const now = new Date();
                    const sunset = new Date(d.results.sunset);
                    const sunrise = new Date(d.results.sunrise);
                    
                    if (now > sunset) {
                        document.getElementById('sunset-time').textContent = sunrise.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                        document.getElementById('sunset-label').textContent = 'Sunrise';
                    } else {
                        document.getElementById('sunset-time').textContent = sunset.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                        document.getElementById('sunset-label').textContent = 'Sunset';
                    }
                }
            } catch (e) { console.error('Sunset API error:', e); }
        }

        function enableFullscreen() {
            document.addEventListener('dblclick', () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
                else document.exitFullscreen();
            });
        }

        async function init() {
            initForecastChart();
            initPressureChart();
            initWeekChart();
            enableFullscreen();
            await fetchMesoWestData();
            await fetchNWSForecast();
            await fetchSunsetTime();
            setInterval(fetchMesoWestData, CONFIG.UPDATE_INTERVAL_WEATHER);
            setInterval(fetchNWSForecast, CONFIG.UPDATE_INTERVAL_FORECAST);
            setInterval(fetchSunsetTime, 60 * 60 * 1000);
            
            document.addEventListener('visibilitychange', async () => {
                if (document.visibilityState === 'visible') {
                    await fetchMesoWestData();
                    await fetchNWSForecast();
                    await fetchSunsetTime();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
